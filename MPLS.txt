#Enable cef
configure terminal
ip cef
end

#Oeiras
configure terminal
int Loopback0
ip address 192.168.2.3 255.255.255.255
ip ospf 1 area 0
no shutdown
end
write

#Aveiro
configure terminal
int Loopback0
ip address 192.168.2.4 255.255.255.255
ip ospf 1 area 0
no shutdown
end
write

#EmpA1
configure terminal
int Loopback0
ip address 192.168.2.5 255.255.255.255
ip ospf 1 area 0
no shutdown
end
write

#EmpB1
configure terminal
int Loopback0
ip address 192.168.2.6 255.255.255.255
ip ospf 1 area 0
no shutdown
end
write

##############
## MPLS LDP ##
##############
#EmpA1
configure terminal
mpls ip
int f0/0
mpls ip
end

#EmpB1
configure terminal
mpls ip
int f0/0
mpls ip
int f0/1
mpls ip
end

#Aveiro
configure terminal
mpls ip
int f0/0
mpls ip
int f0/1
mpls ip
int f1/0
mpls ip
end

#Porto
configure terminal
mpls ip
int f0/1
mpls ip
end

#Lisboa
configure terminal
mpls ip
int f2/0
mpls ip
int f0/1
mpls ip
end

#Oeiras
configure terminal
mpls ip
int f0/0
mpls ip
end

############
##MPLS-VPN##
############
#Oeiras
configure terminal
router ospf 1
no network 192.168.1.24 0.0.0.7 area 0
exit
int f0/1
int f0/1.1
encapsulation dot1Q 1
ip address 192.168.1.25 255.255.255.252
no ip ospf 1 area 0
no shutdown
int f0/1.2
encapsulation dot1Q 2
ip address 192.168.1.29 255.255.255.252
ip ospf 1 area 0
no shutdown
end

#VPN A1
#EmpA1 - aveiro
configure terminal
ip vrf VPN-1
rd 200:1
route-target export 200:1
route-target import 200:1
exit
int f0/1
ip vrf forwarding VPN-1
ip address 110.1.1.1 255.255.255.0
end
write

#EmpA1 - oeiras
configure terminal
ip vrf VPN-1
rd 200:1
route-target export 200:1
route-target import 200:1
exit
int f0/1
int f0/1.1
ip vrf forwarding VPN-1
ip address 192.168.1.25 255.255.255.248
end
write

#BGP reconfigure
#EmpA1 aveiro
configure terminal
router bgp 1000
bgp router-id 5.5.5.5
neighbor 192.168.2.3 remote-as 1000
neighbor 192.168.2.3 update-source Loopback0
address-family vpnv4 
neighbor 192.168.2.3 activate
neighbor 192.168.2.3 send-community both
exit
address-family ipv4 vrf VPN-1
redistribute connected
end


#EmpA1 oeiras
configure terminal
router bgp 1000
bgp router-id 3.3.3.3
neighbor 192.168.2.5 remote-as 1000
neighbor 192.168.2.5 update-source Loopback0
address-family vpnv4
neighbor 192.168.2.5 activate
neighbor 192.168.2.5 send-community both
exit
address-family ipv4 vrf VPN-1
redistribute connected
end

#other bgp // not needed
configure terminal
router bgp 1000
no neighbor 192.168.2.5 remote-as 1000
no neighbor 192.168.2.5 update-source Loopback0
no neighbor 192.168.2.3 remote-as 1000
no neighbor 192.168.2.3 update-source Loopback0
address-family vpnv4 
neighbor 192.168.2.3 activate
neighbor 192.168.2.3 send-community both
neighbor 192.168.2.5 activate
neighbor 192.168.2.5 send-community both
exit
address-family ipv4 vrf VPN-1
redistribute connected
end

#default routes
#EmpA1
configure terminal
ip route vrf VPN-1 0.0.0.0 0.0.0.0 192.168.2.4 global
ip route 110.1.1.0 255.255.255.0 FastEthernet0/1
router ospf 1
redistribute static subnets
end

#Oeiras VPN-1
configure terminal
ip route vrf VPN-1 0.0.0.0 0.0.0.0 192.168.2.2 global
ip route 192.168.1.24 255.255.255.252 FastEthernet0/1.1
router ospf 1
redistribute static subnets
end

##BGP needs to get this static vpn address
#Porto e Lisboa
configure terminal
router bgp 1000
redistribute ospf 1 match external 2
end
write

///NOT WORKING///
############
##MPLS-TE###
############
#Lisboa
configure terminal
mpls traffic-eng tunnels 
int f0/1
mpls traffic-eng tunnels 
int f2/0
mpls traffic-eng tunnels
end

configure terminal
no mpls traffic-eng tunnels 
int f0/1
no mpls traffic-eng tunnels 
int f2/0
no mpls traffic-eng tunnels
end

#Porto
configure terminal
mpls traffic-eng tunnels 
int f0/1
mpls traffic-eng tunnels
end

configure terminal
no mpls traffic-eng tunnels 
int f0/1
no mpls traffic-eng tunnels
end

#Oeiras
configure terminal
mpls traffic-eng tunnels 
int f0/0
mpls traffic-eng tunnels
int f0/1
mpls traffic-eng tunnels
end

configure terminal
no mpls traffic-eng tunnels 
int f0/0
no mpls traffic-eng tunnels
int f0/1
no mpls traffic-eng tunnels
end

#Aveiro
configure terminal
mpls traffic-eng tunnels 
int f0/0
mpls traffic-eng tunnels
int f0/1
mpls traffic-eng tunnels
int f1/0
mpls traffic-eng tunnels
end

configure terminal
no mpls traffic-eng tunnels 
int f0/0
no mpls traffic-eng tunnels
int f0/1
no mpls traffic-eng tunnels
int f1/0
no mpls traffic-eng tunnels
end

#EmpA1
configure terminal
mpls traffic-eng tunnels 
int f0/0
mpls traffic-eng tunnels
end

configure terminal
no mpls traffic-eng tunnels 
int f0/0
no mpls traffic-eng tunnels
end

#EmpB1
configure terminal
mpls traffic-eng tunnels 
int f0/0
mpls traffic-eng tunnels
int f0/1
mpls traffic-eng tunnels
end

configure terminal
no mpls traffic-eng tunnels 
int f0/0
no mpls traffic-eng tunnels
int f0/1
no mpls traffic-eng tunnels
end

#ATIVATE IN OSPF1
configure terminal
router ospf 1
mpls traffic-eng area 0
mpls traffic-eng router-id Loopback0
end

configure terminal
router ospf 1
no mpls traffic-eng area 0
no mpls traffic-eng router-id Loopback0
end

#Reiniciar OSPF 1
clear ip ospf process

#Ativae RSVP em cada interface fisica
#Oeiras
configure terminal
int f0/0
ip rsvp bandwidth 250000 40000
int f0/1
ip rsvp bandwidth 250000 40000
end

configure terminal
int f0/0
no ip rsvp bandwidth 250000 40000
int f0/1
no ip rsvp bandwidth 250000 40000
end

#Aveiro
configure terminal
int f0/0
ip rsvp bandwidth 250000 40000
int f0/1
ip rsvp bandwidth 250000 40000
int f1/0
ip rsvp bandwidth 250000 40000
end

configure terminal
int f0/0
no ip rsvp bandwidth 250000 40000
int f0/1
no ip rsvp bandwidth 250000 40000
int f1/0
no ip rsvp bandwidth 250000 40000
end

#Lisboa
configure terminal
int f2/0
ip rsvp bandwidth 250000 40000
int f0/1
ip rsvp bandwidth 250000 40000
end

configure terminal
int f2/0
no ip rsvp bandwidth 250000 40000
int f0/1
no ip rsvp bandwidth 250000 40000
end



#Porto
configure terminal
int f0/1
ip rsvp bandwidth 250000 40000
end

configure terminal
int f0/1
no ip rsvp bandwidth 250000 40000
end

#EmpA1
configure terminal
int f0/0
ip rsvp bandwidth 250000 40000
end

configure terminal
int f0/0
no ip rsvp bandwidth 250000 40000
end

#EmpB1
configure terminal
int f0/0
ip rsvp bandwidth 250000 40000
int f0/1
ip rsvp bandwidth 250000 40000
end

conf terminal
int f0/0
no ip rsvp bandwidth 250000 40000
int f0/1
no ip rsvp bandwidth 250000 40000

##DOIS TUNEIS BIDIRECIONAIS ENTRE OEIRAS E EMPB1
#Oeiras
configure terminal
int tunnel 1
ip unnumbered Loopback0
tunnel destination 192.168.2.6
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 30720
tunnel mpls traffic-eng path-option 1 dynamic
int tunnel 2
ip unnumbered Loopback0
tunnel destination 192.168.2.6
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 30720
tunnel mpls traffic-eng path-option 1 dynamic
end

#EmpB1
configure terminal
int tunnel 1
ip unnumbered Loopback0
tunnel destination 192.168.2.3
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 30720
tunnel mpls traffic-eng path-option 1 dynamic
int tunnel 2
ip unnumbered Loopback0
tunnel destination 192.168.2.3
tunnel mode mpls traffic-eng
tunnel mpls traffic-eng bandwidth 30720
tunnel mpls traffic-eng path-option 1 dynamic
end

configure terminal
no int tunnel 1
no int tunnel 2

#static routes
#Oeiras
configure terminal
ip route 111.1.1.0 255.255.255.0 tunnel1
ip route 111.1.1.0 255.255.255.0 tunnel2
end

configure terminal
no ip route 111.1.1.0 255.255.255.0 tunnel1
no ip route 111.1.1.0 255.255.255.0 tunnel2
end

#EmpB1
configure terminal
ip route 192.168.1.27 255.255.255.255 tunnel1
ip route 192.168.1.27 255.255.255.255 tunnel2
end

configure terminal
no ip route 192.168.1.27 255.255.255.255 tunnel1
no ip route 192.168.1.27 255.255.255.255 tunnel2
end


